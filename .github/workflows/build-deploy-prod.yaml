# name: Build and Deploy - Production

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'frontend/**'
#       - 'k8s/helm/**'
#   workflow_dispatch:

# env:
#   AWS_REGION: ap-south-1
#   DOCKER_REPOSITORY: nainika/frontend-app
#   EKS_CLUSTER_NAME: nasa-eks
#   NAMESPACE: prod
#   ENVIRONMENT: production

# jobs:
#   build-and-deploy:
#     name: Build and Deploy to Production
#     runs-on: ubuntu-latest
#     environment:
#       name: production
#       url: https://nainika.store
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-region: ${{ env.AWS_REGION }}
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_HUB_USERNAME }}
#           password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
      
#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./frontend
#           file: ./frontend/Dockerfile
#           push: true
#           tags: |
#             ${{ env.DOCKER_REPOSITORY }}:latest
#             ${{ env.DOCKER_REPOSITORY }}:${{ github.sha }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
      
#       - name: Update kubeconfig
#         run: |
#           aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      
#       - name: Install Helm
#         uses: azure/setup-helm@v3
#         with:
#           version: '3.12.0'
      
#       - name: Deploy to Kubernetes
#         run: |
#           helm upgrade --install frontend-app-prod ./k8s/helm/frontend-app \
#             -f ./k8s/helm/frontend-app/value-prod.yaml \
#             -n ${{ env.NAMESPACE }} \
#             --set image.tag=${{ github.sha }} \
#             --wait --timeout=10m
      
#       - name: Verify deployment
#         run: |
#           kubectl rollout status deployment/frontend-app-prod -n ${{ env.NAMESPACE }} --timeout=300s
#           kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=frontend-app# name: Build and Deploy - Production

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'frontend/**'
#       - 'k8s/helm/**'
#   workflow_dispatch:

# env:
#   AWS_REGION: ap-south-1
#   DOCKER_REPOSITORY: nainika/frontend-app
#   EKS_CLUSTER_NAME: nasa-eks
#   NAMESPACE: prod
#   ENVIRONMENT: production

# jobs:
#   build-and-deploy:
#     name: Build and Deploy to Production
#     runs-on: ubuntu-latest
#     environment:
#       name: production
#       url: https://nainika.store
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-region: ${{ env.AWS_REGION }}
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_HUB_USERNAME }}
#           password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
      
#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./frontend
#           file: ./frontend/Dockerfile
#           push: true
#           tags: |
#             ${{ env.DOCKER_REPOSITORY }}:latest
#             ${{ env.DOCKER_REPOSITORY }}:${{ github.sha }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
      
#       - name: Update kubeconfig
#         run: |
#           aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      
#       - name: Install Helm
#         uses: azure/setup-helm@v3
#         with:
#           version: '3.12.0'
      
#       - name: Deploy to Kubernetes
#         run: |
#           helm upgrade --install frontend-app-prod ./k8s/helm/frontend-app \
#             -f ./k8s/helm/frontend-app/value-prod.yaml \
#             -n ${{ env.NAMESPACE }} \
#             --set image.tag=${{ github.sha }} \
#             --wait --timeout=10m
      
#       - name: Verify deployment
#         run: |
#           kubectl rollout status deployment/frontend-app-prod -n ${{ env.NAMESPACE }} --timeout=300s
#           kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=frontend-app
